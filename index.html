
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>LabCopy ‚Äì Extra√ß√£o Exata (L03.pdf)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 30px;
      background: #f5f5f5;
    }
    .upload-box {
      max-width: 600px;
      margin: 0 auto 20px auto;
      padding: 20px;
      background: #fff;
      border: 2px dashed #4CAF50;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: background 0.3s, border-color 0.3s;
    }
    .upload-box:hover {
      background: #f0fff0;
      border-color: #45a049;
    }
    #fileInput {
      display: none;
    }
    #mensagem {
      max-width: 600px;
      margin: 20px auto;
      padding: 15px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      font-size: 1em;
      color: #333;
      min-height: 2em;
      text-align: center;
    }
    #resultado table {
      width: 100%;
      max-width: 600px;
      margin: 20px auto;
      border-collapse: collapse;
      background: #fff;
    }
    #resultado th,
    #resultado td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    #resultado th {
      background: #e9ecef;
    }
  </style>
  <!-- PDF.js via CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
</head>
<body>

  <div class="upload-box" id="uploadLabel">
    <p>üìÑ Clique ou arraste o PDF aqui para extrair os campos exatos:</p>
    <ul style="list-style: none; padding: 0 0 0 20px;">
      <li>‚Ä¢ Ganhos (mL) = √∫ltimo valor ap√≥s ‚Äú<strong>Total de Ganhos (mL)</strong>‚Äù</li>
      <li>‚Ä¢ Diurese (mL) = √∫ltimo valor ap√≥s ‚Äú<strong>Diurese (Volume/ml)</strong>‚Äù</li>
      <li>‚Ä¢ Perdas (mL) = √∫ltimo valor ap√≥s ‚Äú<strong>Total de Perdas (mL)</strong>‚Äù</li>
      <li>‚Ä¢ Hemodialise = √∫ltimo valor ap√≥s ‚Äú<strong>Hemodialise</strong>‚Äù (se vier ‚Äú‚Äì‚Äù, devolve ‚Äú‚Äì‚Äù)</li>
      <li>‚Ä¢ Balan√ßo H√≠drico (mL) = √∫ltimo valor ap√≥s ‚Äú<strong>Evolu√ß√£o (Ganhos-Perdas)</strong>‚Äù</li>
      <li>‚Ä¢ HGT (Maior/Menor) (mg/dL) = menor/maior de todos os valores ap√≥s ‚Äú<strong>Glicemia - MG/DL</strong>‚Äù</li>
      <li>‚Ä¢ Temperatura (¬∞C) = menor/maior de todos os valores ap√≥s ‚Äú<strong>Temperatura - ¬∞C</strong>‚Äù</li>
    </ul>
  </div>

  <input type="file" id="fileInput" accept=".pdf">
  <div id="mensagem">Nenhum PDF carregado.</div>
  <div id="resultado"></div>

  <script>
    // 1) Configura o worker do PDF.js (via CDN)
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

    const uploadLabel = document.getElementById('uploadLabel');
    const fileInput   = document.getElementById('fileInput');
    const mensagemEl  = document.getElementById('mensagem');
    const resultadoEl = document.getElementById('resultado');

    uploadLabel.addEventListener('click', () => fileInput.click());
    uploadLabel.addEventListener('dragover', e => {
      e.preventDefault();
      uploadLabel.style.borderColor = '#45a049';
    });
    uploadLabel.addEventListener('dragleave', e => {
      e.preventDefault();
      uploadLabel.style.borderColor = '#4CAF50';
    });
    uploadLabel.addEventListener('drop', e => {
      e.preventDefault();
      uploadLabel.style.borderColor = '#4CAF50';
      const file = e.dataTransfer.files[0];
      if (file && file.type === 'application/pdf') {
        processarPDF(file);
      }
    });
    fileInput.addEventListener('change', e => {
      const file = e.target.files[0];
      if (file && file.type === 'application/pdf') {
        processarPDF(file);
      }
    });

    // 2) Converte TODO o PDF em uma grande string
    async function pdfToText(file) {
      const buffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: buffer }).promise;
      let texto = '';
      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        texto += content.items.map(item => item.str).join('\n') + '\n';
      }
      return texto;
    }

    // 3) Normaliza o texto removendo linhas vazias/extras
    function normalizeText(raw) {
      return raw
        .replace(/\r\n/g, '\n')
        .replace(/\r/g, '\n')
        .split('\n')
        .map(line => line.trim())
        .filter(line => line.length > 0)
        .join('\n');
    }

    // 4) Procura o √öLTIMO n√∫mero estritamente v√°lido (ex: 306.0 ou 200 ou -50) ap√≥s um r√≥tulo
    function ultimoNumeroAposRotulo(texto, rotulo) {
      // Busca a posi√ß√£o onde ‚Äúrotulo‚Äù (case-insensitive) aparece
      const idx = texto.search(new RegExp(rotulo, 'i'));
      if (idx === -1) return null;
      // Pega tudo que vem depois do final do r√≥tulo
      const apos = texto.slice(idx + rotulo.length);
      // Divide em tokens pelos espa√ßos
      const tokens = apos.split(/\s+/);
      // Regex que aceita strings como ‚Äú306.0‚Äù, ‚Äú0.0‚Äù, ‚Äú-200‚Äù, ‚Äú3,5‚Äù e nada mais
      const reNum = /^-?\d+([.,]\d+)?$/;
      let ultimo = null;
      for (const tok of tokens) {
        if (reNum.test(tok)) {
          // Converte ‚Äú3,5‚Äù em 3.5 e armazena em ‚Äúultimo‚Äù
          ultimo = parseFloat(tok.replace(',', '.'));
        } else {
          // Se o token n√£o for esse formato de n√∫mero, para de varrer
          break;
        }
      }
      return (ultimo !== null) ? ultimo : null;
    }

    // 5) Captura MIN/M√ÅX de todos os valores imediatamente ap√≥s um r√≥tulo
    function minMaxAposRotulo(texto, rotulo) {
      const idx = texto.search(new RegExp(rotulo, 'i'));
      if (idx === -1) return null;
      const apos = texto.slice(idx + rotulo.length);
      const tokens = apos.split(/\s+/);
      const reNum = /^-?\d+([.,]\d+)?$/;
      const numeros = [];
      for (const tok of tokens) {
        if (reNum.test(tok)) {
          numeros.push(parseFloat(tok.replace(',', '.')));
        } else {
          break;
        }
      }
      if (!numeros.length) return null;
      return {
        min: Math.min(...numeros),
        max: Math.max(...numeros)
      };
    }

    // 6) Fun√ß√µes espec√≠ficas para cada campo:
    function extrairGanhos(texto) {
      // ‚ÄúTotal de Ganhos (mL)‚Äù est√° no PDF. Pega o URLTIMO n√∫mero dessa sequ√™ncia.
      const val = ultimoNumeroAposRotulo(texto, 'Total de Ganhos (mL)');
      return (val !== null) ? val : '-';
    }

    function extrairPerdas(texto) {
      let val = ultimoNumeroAposRotulo(texto, 'Total de Perdas (mL)');
      if (val !== null && val > 0) {
        // Se vier positivo, transformamos em negativo (volume de sa√≠da)
        val = -val;
      }
      return (val !== null) ? val : '-';
    }

    function extrairDiurese(texto) {
      // Primeiro tentamos ‚ÄúDiurese (Volume/ml)‚Äù
      let val = ultimoNumeroAposRotulo(texto, 'Diurese (Volume/ml)');
      if (val === null) {
        // Se n√£o achar, capturamos ‚ÄúDiurese <n√∫mero>‚Äù
        const m = texto.match(/Diurese\s+(-?\d+([.,]\d+)?)/i);
        if (m) {
          val = parseFloat(m[1].replace(',', '.'));
        }
      }
      // Diurese √© sa√≠da de l√≠quido, ent√£o deixamos negativo
      if (val !== null && typeof val === 'number' && val > 0) {
        val = -val;
      }
      return (val !== null) ? val : '-';
    }

    function extrairHemodialise(texto) {
      // Captura ‚ÄúHemodialise‚Äù e, a seguir, varre tokens at√© o primeiro que N√ÉO seja n√∫mero.
      const idx = texto.search(/Hemodialise/i);
      if (idx === -1) return '-';
      const apos = texto.slice(idx + 'Hemodialise'.length);
      const tokens = apos.split(/\s+/);
      const reNum = /^-?\d+([.,]\d+)?$/;
      let ultimo = null;
      for (const tok of tokens) {
        if (reNum.test(tok)) {
          ultimo = parseFloat(tok.replace(',', '.'));
        } else {
          break;
        }
      }
      return (ultimo !== null) ? ultimo : '-';
    }

    function extrairBalanco(texto) {
      // Pega o √∫ltimo valor ap√≥s ‚ÄúEvolu√ß√£o (Ganhos-Perdas)‚Äù
      const val = ultimoNumeroAposRotulo(texto, 'Evolu√ß√£o (Ganhos-Perdas)');
      return (val !== null) ? val : '-';
    }

    function extrairHGT(texto) {
      // Coleta todos os n√∫meros ap√≥s ‚ÄúGlicemia - MG/DL‚Äù e retorna ‚Äúmenor/maior‚Äù
      const mm = minMaxAposRotulo(texto, 'Glicemia - MG/DL');
      if (!mm) return '-';
      return `${mm.min}/${mm.max}`;
    }

    function extrairTemperatura(texto) {
      // Coleta todos os n√∫meros ap√≥s ‚ÄúTemperatura - ¬∞C‚Äù e retorna ‚Äúmenor/maior‚Äù
      const mm = minMaxAposRotulo(texto, 'Temperatura - ¬∞C');
      if (!mm) return '-';
      return `${mm.min}/${mm.max}`;
    }

    // 7) Monta a tabela HTML com os sete campos
    function exibirResultados(campos) {
      const rows = [
        ['Ganhos (mL)',                campos.Ganhos],
        ['Diurese (mL)',              campos.Diurese],
        ['Perdas (mL)',               campos.Perdas],
        ['Hemodialise',               campos.Hemodialise],
        ['HGT (Maior/Menor) (mg/dL)', campos.HGT],
        ['Temperatura (¬∞C)',          campos.Temperatura],
        ['Balan√ßo H√≠drico (mL)',      campos['Balan√ßo H√≠drico']]
      ];

      let html = '<table><thead><tr><th>Campo</th><th>Valor</th></tr></thead><tbody>';
      rows.forEach(([label, val]) => {
        let exibir = '-';
        if (typeof val === 'number') {
          // Formata ‚Äú1234‚Äù como ‚Äú1 234‚Äù ou ‚Äú1234,5‚Äù como ‚Äú1 234,5‚Äù
          exibir = val.toLocaleString('pt-BR', { maximumFractionDigits: 0 });
        } else if (typeof val === 'string') {
          exibir = val;
        }
        html += `<tr><td>${label}</td><td>${exibir}</td></tr>`;
      });
      html += '</tbody></table>';
      resultadoEl.innerHTML = html;
    }

    // 8) Fun√ß√£o principal que l√™ o PDF e chama todos os extratores
    async function processarPDF(file) {
      mensagemEl.textContent = 'Lendo PDF... aguarde.';
      resultadoEl.innerHTML = '';
      try {
        const bruto = await pdfToText(file);
        const texto = normalizeText(bruto);

        const campos = {
          Ganhos:      extrairGanhos(texto),
          Diurese:     extrairDiurese(texto),
          Perdas:      extrairPerdas(texto),
          Hemodialise: extrairHemodialise(texto),
          HGT:         extrairHGT(texto),
          Temperatura: extrairTemperatura(texto)
        };
        campos['Balan√ßo H√≠drico'] = extrairBalanco(texto);

        exibirResultados(campos);
        mensagemEl.textContent = 'Resultados extra√≠dos:';
      } catch (err) {
        mensagemEl.textContent = 'Erro ao processar PDF: ' + err.message;
      }
    }
  </script>

</body>
</html>
